package com.synnigeograafia.backend.repository;

import com.synnigeograafia.backend.domain.Person;
import com.synnigeograafia.backend.service.PersonDao;
import com.synnigeograafia.backend.mapper.PersonRowMapper;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.stereotype.Repository;

import java.util.List;
import java.util.Optional;
import java.util.UUID;

@Repository("jdbc")
public class PersonJDBCDataAccessService implements PersonDao {
    private final JdbcTemplate jdbcTemplate;
    private final PersonRowMapper personRowMapper;

    public PersonJDBCDataAccessService(JdbcTemplate jdbcTemplate, PersonRowMapper personRowMapper) {
        this.jdbcTemplate = jdbcTemplate;
        this.personRowMapper = personRowMapper;
    }

    @Override
    public Optional<Person> selectPersonById(UUID id) {
        var sql = """
                SELECT id, ...args
                FROM schema.table_name
                WHERE id = ?
                """;
        return jdbcTemplate.query(sql, personRowMapper, id)
                .stream()
                .findFirst();
    }

    @Override
    public List<Person> selectAllPersons() {
        var sql = """
                SELECT *
                FROM schema.table_name
                LIMIT 1000 -- To make sure that user can't request large chunks of data
                """;
        return jdbcTemplate.query(sql, personRowMapper);
    }

    @Override
    public List<Person> selectPersonByNameLikeIgnoreCase(String name) {
        var sql = """
            SELECT *
            FROM schema.table_name
            WHERE eesnimi ILIKE ? -- ILIKE performs a case-insensitive search
            LIMIT 10
            """;
        return jdbcTemplate.query(sql, personRowMapper, name + "%"); // Appending the wildcard character %
    }

    @Override
    public List<String> selectOnlyPersonNameLikeIgnoreCase(String name) {
        var sql = """
            SELECT eesnimi
            FROM schema.table_name
            WHERE eesnimi ILIKE ? -- ILIKE performs a case-insensitive search
            LIMIT 10
            """;
        return jdbcTemplate.queryForList(sql, String.class, name + "%");
    }
}
